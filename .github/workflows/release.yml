name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run_quality_checks:
    uses: ./.github/workflows/run_all_quality_checks.yml
    secrets: inherit

  release:
    name: semantic-release
    needs: run_quality_checks
    runs-on: ubuntu-latest
    outputs:
      published: ${{ steps.semrel.outputs.new_release_published }}
      version: ${{ steps.semrel.outputs.new_release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # required for semantic-release
          fetch-tags: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run semantic-release
        id: semrel
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
            @semantic-release/github

  docker_publish:
    name: Docker publish (versioned tag)
    needs: [run_quality_checks, release]
    if: needs.release.outputs.published == 'true'
    uses: ./.github/workflows/build_image.yml
    with:
      version: ${{ needs.release.outputs.version }}
      build_env: production
      is_for_local_use: '0'
      push: true
      run-image-scan: false
      tag_latest: true
    secrets: inherit
